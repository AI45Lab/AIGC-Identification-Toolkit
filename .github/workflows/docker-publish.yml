name: Build and Push Docker Image to DockerHub

on:
  # è§¦å‘æ¡ä»¶ 1: main åˆ†æ”¯æŽ¨é€ï¼ˆä»…å½“ Docker ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶ï¼‰
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'requirements.txt'
      - 'setup.py'
      - 'src/**'
      - 'config/**'
      - '.github/workflows/docker-publish.yml'

  # è§¦å‘æ¡ä»¶ 2: æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild without cache'
        required: false
        type: boolean
        default: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout ä»£ç ï¼ˆå…³é”®ï¼šä¸åˆå§‹åŒ– 14GB benchmark å­æ¨¡å—ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1          # æµ…å…‹éš†ï¼ŒåŠ å¿«é€Ÿåº¦
          submodules: false       # ä¸ä¸‹è½½ benchmark å­æ¨¡å—

      # Step 2: è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æž„å»ºå’Œç¼“å­˜ï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: ç™»å½• DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 4: æå– Docker å…ƒæ•°æ®ï¼ˆç”Ÿæˆæ ‡ç­¾å’Œæ ‡ç­¾ï¼‰
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: millionmillionli/aigc-identification-toolkit
          tags: |
            # å§‹ç»ˆä½¿ç”¨ latest æ ‡ç­¾
            type=raw,value=latest
            # æ·»åŠ  commit SHA çŸ­æ ‡ç­¾ç”¨äºŽè¿½æº¯
            type=sha,prefix=sha-,format=short

      # Step 5: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿæž„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # å¦‚æžœæ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©å¼ºåˆ¶æž„å»ºï¼Œåˆ™ç¦ç”¨ç¼“å­˜
          no-cache: ${{ github.event.inputs.force_build == 'true' }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Step 6: ç”Ÿæˆæž„å»ºæ‘˜è¦ï¼ˆæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢ï¼‰
      - name: Generate build summary
        run: |
          echo "### ðŸš€ Docker é•œåƒæž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‹‰å–é•œåƒ:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull millionmillionli/aigc-identification-toolkit:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DockerHub é“¾æŽ¥:** [millionmillionli/aigc-identification-toolkit](https://hub.docker.com/r/millionmillionli/aigc-identification-toolkit)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤ SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
